<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Loedi Kids</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="css/custom.css" rel="stylesheet">
</head>
<body class="py-4">
  <!-- Ic√¥ne de connexion (coh√©rente avec autres pages) -->
  <a id="auth-icon" href="login.html" class="login-icon" title="Connexion" style="display: none;">
    <i class="bi bi-person-circle fs-4"></i>
  </a>

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card card-gradient p-4">
          <h1 class="display-4 fw-bold gradient-text text-center mb-4">üîê Connexion</h1>
          <form id="login-form" autocomplete="off">
            <div class="mb-3">
              <label class="form-label fw-bold">Email</label>
              <input type="email" id="login-email" class="form-control input-focus" placeholder="admin@loedikids.com" autocomplete="username" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Mot de passe</label>
              <input type="password" id="login-password" class="form-control input-focus" placeholder="admin123" autocomplete="current-password" required>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="remember-me">
              <label class="form-check-label small text-muted" for="remember-me">
                Se souvenir de moi
              </label>
            </div>
            <button type="submit" class="btn btn-gradient w-100 py-3 btn-loading" id="login-btn">
              Se Connecter
            </button>
          </form>
          <div id="login-error" class="alert alert-danger mt-3" style="display: none;"></div>
          <div id="login-success" class="alert success-alert mt-3" style="display: none;">
            <p class="mb-3">Connexion r√©ussie !</p>
            <button id="redirect-btn" class="btn btn-gradient w-100" onclick="window.location.replace('admin.html')">
              Acc√©der au Dashboard Admin ‚Üí
            </button>
          </div>
          <div class="text-center mt-3">
            <small class="text-muted">
              Pas de compte ? <a href="register.html">S'inscrire</a>
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Script de connexion -->
  <script type="module">
  // ‚ö†Ô∏è NE PAS importer depuis api.js, on fait la requ√™te directement
  const API_BASE = 'http://localhost:3000/api';

  // ‚úÖ Liste des emails admin (ajoutez-en autant que n√©cessaire)
  const ADMIN_EMAILS = [
    'oceannemandeng@gmail.com',
    'admin@loedikids.com'
  ];

  // V√©rifier si d√©j√† connect√© au chargement
  async function checkExistingAuth() {
    const token = localStorage.getItem('jwtToken');
    console.log('üîç Token existant:', token ? 'OUI' : 'NON');
    
    if (!token) {
      document.getElementById('auth-icon').style.display = 'flex';
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) {
        console.warn('‚ö†Ô∏è Token invalide, suppression');
        localStorage.removeItem('jwtToken');
        document.getElementById('auth-icon').style.display = 'flex';
        return;
      }

      const user = await response.json();
      console.log('‚úÖ D√©j√† connect√©:', user.email);
      
      const successDiv = document.getElementById('login-success');
      successDiv.textContent = `Bienvenue, ${user.email} ! Redirection...`;
      successDiv.style.display = 'block';
      
      setTimeout(() => {
        // ‚úÖ Redirection bas√©e sur l'email
        if (ADMIN_EMAILS.includes(user.email.toLowerCase())) {
          console.log('‚û°Ô∏è Redirection admin');
          window.location.href = 'admin.html';
        } else {
          console.log('‚û°Ô∏è Redirection user');
          window.location.href = 'index.html';
        }
      }, 1500);
      
      document.getElementById('login-form').style.display = 'none';
    } catch (err) {
      console.error('‚ùå Erreur checkExistingAuth:', err);
      localStorage.removeItem('jwtToken');
      document.getElementById('auth-icon').style.display = 'flex';
    }
  }

  // Gestion du formulaire de connexion
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const btn = document.getElementById('login-btn');
    const errorDiv = document.getElementById('login-error');
    const successDiv = document.getElementById('login-success');
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;

    console.log('üîê Tentative de connexion:', email);

    // Loading state
    form.classList.add('login-loading');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Connexion...';
    btn.disabled = true;
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    try {
      // ‚úÖ Appel direct √† l'API de login
      const response = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await response.json();
      console.log('üì¶ R√©ponse backend:', data);

      if (!response.ok) {
        throw new Error(data.error || 'Erreur de connexion');
      }

      // ‚úÖ CRITIQUE : Stocker le token JWT
      if (!data.token) {
        throw new Error('Token manquant dans la r√©ponse du serveur');
      }

      localStorage.setItem('jwtToken', data.token);
      console.log('‚úÖ Token JWT stock√©:', data.token.substring(0, 30) + '...');
      console.log('üîç V√©rification stockage:', localStorage.getItem('jwtToken') ? 'OK' : '√âCHEC');

      // Remember me (stocke email en localStorage)
      if (document.getElementById('remember-me').checked) {
        localStorage.setItem('rememberEmail', email);
      } else {
        localStorage.removeItem('rememberEmail');
      }

      // ‚úÖ V√©rifier si admin
      const isAdmin = ADMIN_EMAILS.includes(email.toLowerCase());
      console.log('üîç Est admin ?', isAdmin);

      // Afficher le message de succ√®s avec bouton
      const redirectBtn = document.getElementById('redirect-btn');
      if (isAdmin) {
        redirectBtn.textContent = 'Acc√©der au Dashboard Admin ‚Üí';
        redirectBtn.onclick = () => window.location.replace('admin.html');
      } else {
        redirectBtn.textContent = 'Acc√©der √† l\'accueil ‚Üí';
        redirectBtn.onclick = () => window.location.replace('index.html');
      }
      successDiv.style.display = 'block';

      // ‚úÖ Tentative de redirection automatique
      console.log('üöÄ Tentative de redirection automatique...');
      setTimeout(() => {
        if (isAdmin) {
          console.log('‚û°Ô∏è Redirection automatique vers admin.html');
          window.location.replace('admin.html');
        } else {
          console.log('‚û°Ô∏è Redirection automatique vers index.html');
          window.location.replace('index.html');
        }
      }, 500); // D√©lai court pour laisser fermer la popup

    } catch (err) {
      console.error('‚ùå Erreur login:', err);
      errorDiv.textContent = err.message || 'Erreur de connexion. V√©rifiez vos identifiants.';
      errorDiv.style.display = 'block';
      
      // Reset loading
      form.classList.remove('login-loading');
      btn.innerHTML = 'Se Connecter';
      btn.disabled = false;
    }
  });

  // Pr√©-remplir l'email si "remember me" activ√©
  document.addEventListener('DOMContentLoaded', () => {
    const rememberedEmail = localStorage.getItem('rememberEmail');
    if (rememberedEmail) {
      document.getElementById('login-email').value = rememberedEmail;
      document.getElementById('remember-me').checked = true;
    }
    checkExistingAuth();
  });
</script>
</body>
</html>